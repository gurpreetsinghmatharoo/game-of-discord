{"version":3,"sources":["../src/util.js"],"names":["api","pagination","aggregatePagination","aggregate","fetchOptions","method","mode","credentials","Object","assign","format","action","redirects","params","keys","qs","forEach","key","apiOptions","origin","apiUrl","querystring","stringify","url","headers","then","res","json","error","Error","info","results","parseResults","query","srsearch","filter","continueType","continueKey","resolution","next","previousResults","pageLimit","list","prefix","map","e","continue","continueWith","nextFromKey","nextResults"],"mappings":"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","file":"util.js","sourcesContent":["import fetch from 'isomorphic-fetch';\nimport querystring from 'querystring';\n\nconst fetchOptions = {\n\tmethod: 'GET',\n\tmode: 'cors',\n\tcredentials: 'omit'\n};\n\nexport function api(apiOptions, params = {}) {\n\tconst qs = Object.assign(\n\t\t{\n\t\t\tformat: 'json',\n\t\t\taction: 'query',\n\t\t\tredirects: ''\n\t\t},\n\t\tparams\n\t);\n\t// Remove undefined properties\n\tObject.keys(qs).forEach(key => {\n\t\tif (qs[key] === undefined) {\n\t\t\tdelete qs[key];\n\t\t}\n\t});\n\tif (apiOptions.origin) {\n\t\tqs.origin = apiOptions.origin;\n\t}\n\tconst url = `${apiOptions.apiUrl}?${querystring.stringify(qs)}`;\n\treturn fetch(\n\t\turl,\n\t\tObject.assign({ headers: apiOptions.headers }, fetchOptions)\n\t)\n\t\t.then(res => res.json())\n\t\t.then(res => {\n\t\t\tif (res.error) {\n\t\t\t\tthrow new Error(res.error.info);\n\t\t\t}\n\t\t\treturn res;\n\t\t});\n}\n\nexport function pagination(apiOptions, params, parseResults) {\n\treturn api(apiOptions, params).then(res => {\n\t\tlet resolution = {};\n\t\tresolution.results = parseResults(res);\n\t\tresolution.query = params.srsearch;\n\t\tif (res['continue']) {\n\t\t\tconst continueType = Object.keys(res['continue']).filter(\n\t\t\t\tkey => key !== 'continue'\n\t\t\t)[0];\n\t\t\tconst continueKey = res['continue'][continueType];\n\t\t\tparams[continueType] = continueKey;\n\t\t\tresolution.next = () => pagination(apiOptions, params, parseResults);\n\t\t}\n\t\treturn resolution;\n\t});\n}\n\nexport function aggregatePagination(pagination, previousResults = []) {\n\treturn pagination.then(res => {\n\t\tconst results = [...previousResults, ...res.results];\n\t\tif (res.next) {\n\t\t\treturn aggregatePagination(res.next(), results);\n\t\t} else {\n\t\t\treturn results;\n\t\t}\n\t});\n}\n\nconst pageLimit = 500;\n\nexport function aggregate(apiOptions, params, list, key, prefix, results = []) {\n\tparams.list = list;\n\tparams[prefix + 'limit'] = pageLimit;\n\treturn api(apiOptions, params).then(res => {\n\t\tconst nextResults = [...results, ...res.query[list].map(e => e[key])];\n\t\tconst continueWith = res['query-continue'] || res.continue;\n\t\tif (continueWith) {\n\t\t\tconst nextFromKey =\n\t\t\t\t(continueWith[list] && continueWith[list][prefix + 'from']) ||\n\t\t\t\tcontinueWith[prefix + 'continue'];\n\t\t\tparams[prefix + 'continue'] = nextFromKey;\n\t\t\tparams[prefix + 'from'] = nextFromKey;\n\t\t\treturn aggregate(apiOptions, params, list, key, prefix, nextResults);\n\t\t}\n\t\treturn nextResults;\n\t});\n}\n"]}